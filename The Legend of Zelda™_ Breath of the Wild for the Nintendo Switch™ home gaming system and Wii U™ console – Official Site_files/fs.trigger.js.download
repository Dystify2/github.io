/***************************************
* @preserve
* ForeSee Web SDK: Trigger
* Built February 11, 17 02:42:53
* Code version: 19.3.1
* Template version: 19.3.1
***************************************/
_fsDefine(["require","fs",_fsNormalizeUrl("$fs.utils.js"),"triggerconfig"],function(e,t,i,config){"string"==typeof t.startTS&&(t.startTS=i.now());var r={loadedEmitter:new i.FSEvent,initializedEmitter:new i.FSEvent,inviteShownEmitter:new i.FSEvent,inviteAcceptedEmitter:new i.FSEvent,inviteDeclinedEmitter:new i.FSEvent,trackerShownEmitter:new i.FSEvent,customInvitationRequested:new i.FSEvent},s={INVITE_SHOWN:"fs_inviteShown",INVITE_ACCEPTED:"fs_inviteAccepted",INVITE_DECLINED:"fs_inviteDeclined",INVITE_ABANDONED:"fs_inviteAbandoned",LINKS_CANCEL:"fs_linksCancel",TRACKER_SHOWN:"fs_trackerShown",TRACKER_CLICKED:"fs_trackerClicked",QUALIFIER_ACCEPTED:"fs_qualifierAccepted",QUALIFIER_DECLINED:"fs_qualifierDeclined",QUALIFIER_SHOWN:"fs_qualifierShown",REMINDER_SHOWN:"fs_reminderShown",REMINDER_ACCEPTED:"fs_reminderAccepted",SURVEY_SHOWN:"fs_surveyShown"};if(config&&config.surveydefs)for(var n=0;n<config.surveydefs.length;n++)t.isString(config.surveydefs[n])&&(config.surveydefs[n]=i.compile(i.b64DecodeUnicode(config.surveydefs[n])));var o=function(e,i,r,s,n){var o={width:700,height:350,left:50,top:50,resizable:"no",scrollbar:"1",scrollbars:"1",toolbar:"no",menubar:"no",location:"1",directories:"no",status:"no"},a=t.ext(o,r),c="";for(var f in a)c+=f+"="+a[f]+",";var d=this._win=window.open(e,i,c);if(d&&n)if(d.blur(),d.opener.window.focus(),window.self.window.focus(),window.focus(),"Firefox"==s.browser.name){var l=window.open("about:blank");l.focus(),l.close()}else s.isIE&&setTimeout(function(){d.blur(),d.opener.window.focus(),window.self.window.focus(),window.focus()},1e3);return d},a=function(){var e=this;this.isOver=!0,i.Bind(document,"trigger:mouseout",function(t){t=t?t:window.event;var i=t.relatedTarget||t.toElement;i&&"HTML"!=i.nodeName||e.isOver&&(e.isOver=!1)},!1),i.Bind(document,"trigger:mouseover",function(t){e.isOver||(e.isOver=!0)},!1),i.Bind(document,"trigger:mousemove",function(t){e.isOver||(e.isOver=!0)})},c=config.config.surveyAsyncCurl,f={SERVICE_TYPES:{mobileOnExitInitialize:{host:c,path:"/e",url:"/initialize"},mobileOnExitHeartbeat:{host:c,path:"/e",url:"/recordHeartbeat"}}};f.log=function(e,t,config,r,s,n,o,a){var c=new Date,f=new i.ImageTransport,d=config.config,l=s.get("rid"),u=s.get("q"),p={ver:1,cid:d.id,rid:l,q:u,type:s.get("dn")||"",site:d.site_id,msg:n,tms:c.getTime(),tmz:6e4*c.getTimezoneOffset()};if(r&&(p.cat=r.name||"",p.sec=r.section||"",p.lang=r.language.locale||""),"object"==typeof t){p.param="";for(var h in t)p.param+=encodeURIComponent(h)+"="+encodeURIComponent(t[h])+"&"}else"string"==typeof t&&(p.param=t);for(var g in p)"undefined"!=typeof p[g]&&null!==p[g]||delete p[g];e&&f.send({url:"https://"+e.host+e.path+(e.url||""),success:o||function(){},failure:a||function(){},data:p})},f.ping=function(e,t,r,s){var n=new i.ImageTransport,o="https://"+e.host+e.path+(e.url||"");n.send({url:o,success:r||function(){},failure:s||function(){},data:t})};var d=function(s,n,o,a,c,f,d,l){if(this.trig=s,this.browser=n,this.stg=o,this.cpps=a,this.events=c,this.displayoverride=f,this.jrny=d,t.isDefined(this.trig.surveydef.inviteExclude)&&t.isDefined(this.trig.crit)&&this.trig.crit.runAllTests(this.trig.surveydef.inviteExclude,this.browser,!1,!0))return!1;var u=this;i.Healthy(this.browser,["survey"],t.proxy(function(){fsReady(function(){s.invite&&s.invite.dispose(),e([t.makeURI("$fs.invite.js")],function(e){var t=u.invite=s.invite=new e(config,s.surveydef,n,o.fstg,f,a,r);o.set("dn",t.display.displayname),a.set("dn",t.display.displayname),l&&l.call(u)})})},this),t.proxy(function(){},this))},l=function(e,t,i){var r=new b(i,config,e.surveydef,e.cpps,e.stg.get("rid"));e.stg.get("mhbi")?r.beginHeartbeat():r.init(t,function(){r.beginHeartbeat()})};d.prototype.initialize=function(){var e=this.trig,n=this.browser,o=this.stg,a=this.cpps,c=this.events,f=(this.displayoverride,this.invite),d=this.jrny;i.Healthy(n,["survey","static"],t.proxy(function(){f.loadResources(function(){setTimeout(function(){f.present(),r.inviteShownEmitter.fire(),c.inviteShown&&c.inviteShown(e.surveydef,o,config,a),d.addEvent(s.INVITE_SHOWN)},Math.max(0,config.config.inviteDelay-(i.now()-t.startTS)))}),f.declined.subscribe(function(){var i=t.isDefined(config.active_surveydef)&&t.isDefined(config.active_surveydef.repeatDays)?config.active_surveydef.repeatDays:config.config.repeatDays;o.setMaxKeyExpiration(24*i.decline*60*60*1e3),d.addEventString(s.INVITE_DECLINED),c.inviteDeclined&&c.inviteDeclined(e.surveydef,o,config,a),r.inviteDeclinedEmitter.fire(),e.surveydef.cxRecord&&r.rec&&(r.rec.cancelRecord(),e.recordController=r.rec=null),o.set("i","d")}),f.abandoned.subscribe(function(){d.addEventString(s.INVITE_ABANDONED),o.set("i","a"),o.set("rw",i.now()+config.config.reinviteDelayAfterInviteAbandon)}),f.accepted.subscribe(function(n,u){var p=t.isDefined(config.active_surveydef)&&t.isDefined(config.active_surveydef.repeatDays)?config.active_surveydef.repeatDays:config.config.repeatDays;switch(o.setMaxKeyExpiration(24*p.accept*60*60*1e3),c.inviteAccepted&&c.inviteAccepted(e.surveydef,o,config,a),r.inviteAcceptedEmitter.fire(),e.surveydef.cxRecord&&r.rec&&r.rec.recorder&&(r.rec.beginTransmitting(),a.set("replay_id",r.rec.recorder.logger.gsessionid),a.set("sessionid",r.rec.recorder.logger.sessionid)),d.addEventString(s.INVITE_ACCEPTED),o.set("i","x"),o.set("ixw",i.now()),n){case"TRACKER":e.popTracker(f);break;case"INSESSION":e.popSurvey();break;case"SMS":case"EMAIL":case"SMSEMAIL":l(e,u,n),e.stg.set("mhbi",{ui:u,it:n})}})},this),t.proxy(function(){},this))};var u=function(config,e,t){this.cfg=config,this.cpps=e,this.def=t,this.locale=e.get("locale")||"en"};u.prototype.getUrl=function(){var e=t.enc,r=this.def,s=t.config.surveyUrl+"?",n=i.now()+"_"+Math.round(1e13*Math.random()),o=r.name+"-"+(t.isDefined(r.site)?r.site+"-":"")+(t.isDefined(r.section)?this.def.section+"-":"")+this.locale,a={sid:e(o),cid:e(this.cfg.config.id),pattern:e(this.cpps.get(r.pattern)),a:n,b:i.hash(n),c:864e5,version:this.cfg.config.version};for(var c in a)s+=t.enc(c)+"="+t.enc(a[c])+"&";return s+=this.cpps.toQueryString()};var p=function(e,s,n,o,c,f,d,l){r.tracker&&(r.tracker.dispose(),r.tracker=null),r.tracker=this,t.ext(this,{template:e,def:s,cfg:n,disp:d,_fcBindings:[]}),this.mtrk=new a,this.cpps=f,this.br=l,this.stg=o,e&&c.trackerShown&&(c.trackerShown(s,o,n,f),r.trackerShownEmitter.fire());var u=t.proxy(function(e){this.stg.set("page_hb",i.now(),n.config.trackerHeartbeatTimeout,!e,i.persistDataType.TRACKER)},this);this._heartbeat=setInterval(u,Math.round(n.config.trackerHeartbeatTimeout/2)),u(!0),i.Bind(window,"unload",t.proxy(function(){this.mtrk.isOver&&this.stg.set("page_hb",i.now(),n.config.trackerHeartbeatLongTimeout,!0,i.persistDataType.TRACKER)},this));var p=t.enc;this._url=t.makeURI("$fs.tracker.html?uid="+p(o.uid||"")+"&sitekey="+p(i.siteKey)+"&domain="+p(i.getRootDomain())+"&stg="+p(this.stg.pers)+"&gw="+p(t.makeURI("trigger/__gwtest__"))+"&brain_url="+p(t.config.brainUrl)+"&fsrlocale="+p(f.get("locale")||"en")+"&_svu_="+p(t.config.surveyUrl)+"&_cv_="+p(t.config.codeVer)+"&_vt_="+p(t.tagVersion)+"&_au_="+p(t.config.analyticsUrl)),o.fr&&o.fr.isSSL&&(this._url=this._url.replace(/http:/gi,"https:").replace(/:\d{3,4}/,""),"//"==this._url.substr(0,2)&&(this._url="https:"+this._url)),this.stg.pers==i.storageTypes.CK&&this.cpps.onSet.subscribe(t.proxy(function(e,t){var r={};r[e]=t,this.stg.set("ckcpps",r,2e5,!0,i.persistDataType.TRACKER)},this)),this._sendDefinition()};p.prototype._sendDefinition=function(){var e={method:"init",cfg:this.cfg,def:this.def};this.disp&&(e.display=this.disp),this.template&&(e.template=this.template),this.stg.set("page_hb",i.now(),this.cfg.config.trackerHeartbeatTimeout,!1,i.persistDataType.TRACKER),this.stg.set("hb_i",this.cfg.config.trackerHeartbeatTimeout,6e4,!1,i.persistDataType.TRACKER),this.stg.set("trackerinfo",e,6e4,!0,i.persistDataType.TRACKER),this.stg.pers==i.storageTypes.CK&&this.stg.set("ckcpps",this.cpps.all(),2e5,!0,i.persistDataType.TRACKER)},p.prototype.show=function(e){this.wref=o(this._url,"fsTracker",{width:700,height:450},e,!0)},p.prototype.applyExisting=function(e,t){this.wref=t,t.location=this._url},p.prototype.dispose=function(){for(var e=0;e<this._fcBindings.length;e++)this._fcBindings[e].unsubscribe();this.fstg=null};var h=function(e,config){this.stg=e,this.cfg=config};h.prototype.calcReplayPoolStatus=function(e){var i,r,s,n,o,a=this.cfg.config,c=a.replay_pools,f=window.location.toString();if(c&&0!==c.length&&this.pooloverride!==!0){if(r=this.stg.get("pl"),!t.isDefined(r))for(i=0;i<c.length;i++)s=new RegExp(c[i].path,"gi"),s.exec(f)&&(r=100*Math.random()<c[i].sp?1:0,this.stg.set("pl",r,144e5));if(n=a.replay_repools,0===r&&n&&n.length>0)for(i=0;i<n.length;i++)o=new RegExp(n[i].path,"gi"),o.exec(f)&&(r=100*Math.random()<n[i].sp?1:0,this.stg.set("pl",r,144e5));e(!!r)}else e(!0)},h.prototype.optoutCheck=function(e,i){this.stg.ready.subscribe(t.proxy(function(){this.stg.get("optout")===!0?i():e()},this),!0,!0)},h.prototype.browserCheck=function(e,t){return!(!e.isMobile&&t.config.browser_cutoff[e.browser.name]&&e.browser.actualVersion<t.config.browser_cutoff[e.browser.name])},h.prototype.featureCheck=function(e,t){return!(t.config.persistence==i.storageTypes.DS&&!e.supportsLocalStorage)},h.prototype.platformCheck=function(e,t){return!(t.config.platform_cutoff[e.os.name]&&e.os.version<t.config.platform_cutoff[e.os.name])},h.prototype.checkDeviceBlacklist=function(e,t){for(var i=0;i<t.config.device_blacklist.length;i++)if(e.agent.toLowerCase().indexOf(t.config.device_blacklist[i].toLowerCase())>-1)return!1;return!0},h.prototype._match=function(e,t,i){var r=e.include,s=e[i||"globalExclude"];if(e.criteria){if(!e.criteria.supportsSmartPhones&&!t.isTablet&&t.isMobile)return!1;if(!e.criteria.supportsTablets&&t.isTablet)return!1;if(!e.criteria.supportsDesktop&&!t.isMobile)return!1}var n=window.location.href.toString(),o=document.referrer.toString();({urls:n,referrers:o,userAgents:window.navigator.userAgent});if(s){var a=this.runAllTests(s,t,!1,!0);if(a)return!1}return!r||this.runAllTests(r,t,!1,!0)},h.prototype.runAllTests=function(e,r,s,n){function o(e,i){t.isArray(i)||(i=[i]);for(var r=0,s=i.length;r<s;r++)if("string"==typeof i[r]&&(i[r]=i[r].replace(/-_DS_-/gi,"$")),(e+"").match(i[r]))return!0;return!1}var a,c=new i.Cookie({}),f=window.location.href.toString(),d=document.referrer.toString(),l={urls:f,referrers:d,userAgents:window.navigator.userAgent};for(var u in e){var p=e[u];if(p.length>0){if(a=!1,l[u])a=o(l[u],p);else if("browsers"==u)for(var h=r.browser.name,g=r.browser.actualVersion,v=0;v<p.length;v++)h.toLowerCase().indexOf(p[v].name.toLowerCase())>-1&&(p[v].comparison?"lt"==p[v].comparison&&g<p[v].version?a=!0:"eq"==p[v].comparison&&g==p[v].version?a=!0:"gt"==p[v].comparison&&g>p[v].version&&(a=!0):a=!0);else if("cookies"==u)for(var y=0;y<p.length;y++){var w=p[y],m=c.get(w.name);t.isDefined(w.value)&&m==w.value?a=!0:!t.isDefined(w.value)&&m&&(a=!0)}else if("variables"==u)for(var b=0;b<p.length;b++){var _=p[b],E=new[].constructor.constructor("var v1 = '';try { v1 = "+_.name+"}catch(err) {}return v1;"),S=E.call(window);t.isDefined(_.value)&&S.match(_.value)?a=!0:!t.isDefined(_.value)&&S&&(a=!0)}if(!a&&s)return!0;if(a&&n)return!0}}return!1};var g=function(e){this.cfg=e};g.prototype._bindToLink=function(e,t){for(var r=document.querySelectorAll(e.selector),s=function(e,t,r){return function(s){t.preventDefault&&i.preventDefault(s),r.call(e,t)}},n=0;n<r.length;n++){var o,a=r[n],c=!0;if(e.attribute&&(o=a.getAttribute(e.attribute),c=!1,o&&(c=!0,e.patterns&&e.patterns.length>0))){c=!1;for(var f=0;f<e.patterns.length;f++)if(o.toLowerCase().indexOf(e.patterns[f].toLowerCase())>-1){c=!0;break}}c&&i.Bind(a,"trigger:click",s(this,e,t))}},g.prototype.performBindings=function(e){if(e&&this.cfg){var t,i=this.cfg;if(i.cancel&&i.cancel.length>0){var r=function(){e.cancelTracker(),e.jrny.addEventString(s.LINKS_CANCEL)};for(t=0;t<i.cancel.length;t++)this._bindToLink(i.cancel[t],r)}if(i.survey&&i.survey.length>0){var n=function(){e.popSurvey()};for(t=0;t<i.survey.length;t++)this._bindToLink(i.survey[t],n)}if(!e.browser.isMobile&&i.tracker&&i.tracker.length>0){var o=function(){e.popTracker()};for(t=0;t<i.tracker.length;t++)this._bindToLink(i.tracker[t],o)}}};var v=function(e,s,n,o,a,c,f){var l={},u=e.FSR||{};u.CPPS;l.CPPS=o,l.clearState=function(){s.reset(),r.rec&&r.rec.recorder&&r.rec.recorder.clearState()},l.getConfig=function(){return config},l.getConfigFormatted=function(){if(console&&console.info&&(console.info("************************** Trigger Configuration **************************"),console.info("Config: ",config.config),config.surveydefs&&config.surveydefs.length)){console.info("************************** Surveydefs Configuration **************************");for(var e=0;e<config.surveydefs.length;e++)console.info("************************** Surveydef "+(e+1)+" **************************"),console.info("Config: ",config.surveydefs[e])}},l.optOut=function(){var e=window.location.toString();window.location=e.indexOf("#")?e.substr(0,e.indexOf("#")-1)+"#acscommand=fsoptout":e+"#acscommand=fsoptout",window.location.reload()},l.test=function(){var e=window.location.toString();window.location=e.indexOf("#")?e.substr(0,e.indexOf("#")-1)+"#acscommand=fstest":e+"#acscommand=fstest",window.location.reload()};var p;l.run=l.pageReset=function(){p&&(clearTimeout(p),p=null),p=setTimeout(function(){var e=r.trig;e&&(e.dispose(),r.trig=null),t.startTS=i.now(),setTimeout(function(){T()},50)},250)},l.showInvite=function(e){var l=new i.Browser;l.ready.subscribe(t.proxy(function(){var t=r.trig||w(s,config,l,n,o,a,c);if(t.init()&&t.surveydef){new d(t,l,s,o,c,e,f,function(){this.initialize()})}},this),!0,!0)},l.getCookie=function(e){return a.get(e)},l.onLoaded=r.loadedEmitter,l.onInitialized=r.initializedEmitter,l.onInviteShown=r.inviteShownEmitter,l.onInviteAccepted=r.inviteAcceptedEmitter,l.onInviteDeclined=r.inviteDeclinedEmitter,l.onTrackerShown=r.trackerShownEmitter,l.customInvitationRequested=r.customInvitationRequested,l.getKey=l.getStorage=function(e){return e?s.get(e):s},l.Event=f;var h=config.config.publicApiName||"FSR";e[h]||(e[h]={}),t.ext(e[h],l,!1)},y=function(i,s,n,o,a,c){s&&o&&e([t.makeURI("$fs.record.js")],function(e){n.set("rc","true"),r.rec=e.getInstance(i,window,n),c&&(c.recordController=rec)})},w=function(e,config,t,i,r,s,n,o){var a=new m(e,config,t,i,r,o);return a},m=function(e,r,s,n,o,a){this.stg=e,this.cfg=r,this.browser=s,this.crit=n,this.cpps=o,this.jrny=a;var c=r.config.disable_default_cpps,f=function(e){return!c||c.indexOf(e.toLowerCase())<0};if(t.isArray(c))for(var d=0,l=c.length;d<l;d++)c[d]=c[d].toLowerCase();if(!e.get("pv")){f("terms")&&o.set("terms",this.decodeReferrer()||""),f("browser")&&o.set("browser",s.browser.name+" "+s.browser.version),f("os")&&o.set("os",s.os.name),f("referrer")&&o.set("referrer",document.referrer.toString()),f("site")&&o.set("site",r.config.site_id),f("code")&&o.set("code",t.config.codeVer),o.set("fp",s.fp),f("GA_ID")&&i.INT.GA.has()&&setTimeout(t.proxy(function(){i.INT.GA.uid(function(e){e&&o.set("GA_ID",e)})},this),2e3),f("OMTR_VID")&&i.INT.OM.has()&&setTimeout(t.proxy(function(){i.INT.OM.uid(function(e){e&&o.set("OMTR_VID",e)})},this),2e3);var u=i.INT.OM.beacon();f("OMTR_BEACON")&&u&&o.set("OMTR_BEACON",u)}this.heartbeatExpired=new i.FSEvent};m.prototype.doesPassCriteria=function(){var e=this.crit,t=this.cfg;return!!(e.platformCheck(this.browser,t)&&e.browserCheck(this.browser,t)&&e.checkDeviceBlacklist(this.browser,t)&&e.featureCheck(this.browser,t))},m.prototype.popTracker=function(e){var t=this;if(this.stg.set("i","x"),this.didPopTrackerAlready="y"==this.stg.get("dt"),!this.didPopTrackerAlready){this.stg.set("dt","y");var i=function(){t.tracker=new p(e.template,t.surveydef,config,t.stg,config.config.events,t.cpps,e.display,t.browser),t.tracker.show(t.browser)};if(e)i();else{var s=o("about:blank","fsTracker",{width:700,height:400},this.browser,!0);new d(this,t.browser,t.stg,t.cpps,config.config.events,!1,t.jrny,function(){t.tracker=new p(this.invite.template,t.surveydef,config,t.stg,config.config.events,t.cpps,this.invite.display,t.browser),t.tracker.applyExisting(t.browser,s),t.surveydef.cxRecord&&r.rec&&r.rec.recorder&&(r.rec.beginTransmitting(),t.cpps.set("replay_id",r.rec.recorder.logger.gsessionid),t.cpps.set("sessionid",r.rec.recorder.logger.sessionid))})}}},m.prototype.canDisplayInvitation=function(){return this.crit._match(this.cfg.config,this.browser,"inviteExclude")},m.prototype.popSurvey=function(){if(this.stg.set("i","x"),this.didPopTrackerAlready="y"==this.stg.get("dt"),this.didPopTrackerAlready)this.stg&&this.stg.fstg&&this.frm._postMessage("trackercmd",{method:"survey"});else{this.stg.set("dt","y");var e=new u(config,this.cpps,this.surveydef),t=e.getUrl();o(t,"acsSurvey",{width:700,height:400},this.browser,!0);this.jrny.addEventString(s.SURVEY_SHOWN)}},m.prototype.init=function(){var e,i,r,s=this.cfg.surveydefs,n=this.stg.get("def");for(e=0;e<s.length;e++)r=s[e],i&&(r=t.ext(i,r),!s[e].site&&i.site&&delete r.site,!s[e].section&&i.section&&delete r.section,s[e]=r),i=t.ext({},r);if(t.isDefined(n)&&parseInt(n)>s.length-1&&(n=void 0),t.isDefined(n)&&"default"!=s[parseInt(n)].selectMode&&"pin"!=s[parseInt(n)].selectMode){if(t.isDefined(n)||"lock"==s[parseInt(n)].selectMode)return r=s[parseInt(n)],this.cfg.active_surveydef=r,this.surveydef=r,this._setupTrueConversionIfRequired(),this.locale=this._initLocale(),this.cpps.set("locale",this.locale),r}else for(e=0;e<(t.isDefined(n)&&"default"!=s[parseInt(n)].selectMode?parseInt(n)+1:s.length);e++)if(r=s[e],t.isDefined(n)&&n==e&&"default"!=s[parseInt(n)].selectMode||this.crit._match(r,this.browser))return"x"===this.stg.get("i")&&this.stg.set("def",e),r.index=e,this.cfg.active_surveydef=r,this.surveydef=r,this._setupTrueConversionIfRequired(),this.locale=this._initLocale(),this.cpps.set("locale",this.locale),this.inviteIndex=e,r;return!1},m.prototype._initLocale=function(){var e,r=this.surveydef,s=r.language;if(t.isDefined(s.src)&&t.isDefined(s.locales)){switch(s.src){case"variable":t.isDefined(s.name)&&(e=window[s.name]);break;case"cookie":if(t.isDefined(s.name)){var n=new i.Cookie({});e=n.get(s.name)}break;case"url":var o=s.locales;if(t.isDefined(o))for(var a=0,c=o.length;a<c;a++)if(t.isDefined(o[a].locale)&&t.isDefined(o[a].match)&&location.href.match(o[a].match))return this.locale=o[a].locale,o[a].criteria&&t.ext(this.surveydef.criteria,o[a].criteria),o[a].locale}if(e)for(var f=0;f<s.locales.length;f++)if(s.locales[f].match==e)return s.locale=s.locales[f].locale,s.locales[f].criteria&&t.ext(this.surveydef.criteria,s.locales[f].criteria),s.locale}return s.locale||"en"},m.prototype.cancelTracker=function(){this.stg.set("trackercmd",{method:"close"},6e4,!0,i.persistDataType.TRACKER),this.stg.set("i","a"),t.isDefined(this.tracker)&&clearInterval(this.tracker._heartbeat)},m.prototype._setupTrueConversionIfRequired=function(){var i=(this.surveydef,this.cfg.config);i.trueconversion&&i.trueconversion.enabled&&e([t.makeURI("$fs.trueconversion.js")],t.proxy(function(e){this.trueconversion=new e(this)},this))},m.prototype.logState=function(){this.pageViewCount=(this.stg.get("pv")||0)+1,this.stg.set("pv",this.pageViewCount)},m.prototype.logDefState=function(){this.surveydef&&(this.defPageViewCount=(this.stg.get(this.surveydef.name+"pv")||0)+1,this.stg.set(this.surveydef.name+"pv",this.defPageViewCount))},m.prototype.evalLoyaltySampling=function(){var e=this.surveydef,i=this.stg.get("pl"),r=t.isDefined(i)&&1!=i?e.criteria.sp.outreplaypool||0:e.criteria.sp.reg||0,s=100*Math.random();return this.defPageViewCount>=e.criteria.lf&&s<=r},m.prototype.decodeReferrer=function(){var e,t,i=document.referrer||"",r=null,s=["q","p","query"];for(t=0;t<s.length&&!(r=i.match(new RegExp("[?&]"+s[t]+"=([^&]*)")));t++);return r?(e=decodeURIComponent(r[1]),e&&(e=e.replace(/\+/g," ")),e):e},m.prototype.dispose=function(){this.disposed||(this.disposed=!0,this.trueconversion&&this.trueconversion.dispose(),this.invite&&this.invite.dispose(),r.rec&&(r.rec.dispose(),r.rec=null),i.Unbind("trigger:*"))};var b=function(e,i,r,s,n){this.itype=e,this.cfg=i,this.def=r,this.cpps=s,this.rid=n,this._measureName=this.def.name+"-"+(t.isDefined(this.def.site)?this.def.site+"-":"")+(t.isDefined(this.def.section)?this.def.section+"-":"")+this.def.language.locale};b.prototype.init=function(e,t){t=t||function(){};var r=i.now()+"_"+Math.round(1e13*Math.random());f.ping(f.SERVICE_TYPES.mobileOnExitInitialize,{a:r,notify:e,b:i.hash(r),c:864e5,cid:this.cfg.config.id,sid:this._measureName,rid:this.rid,uid:i.now(),support:"SMSEMAIL"==this.itype?"b":"EMAIL"==this.itype?"e":"s",cpps:"version="+encodeURIComponent(this.cfg.config.version)+"&"+this.cpps.toQueryString()},t,t)},b.prototype.beginHeartbeat=function(){this._timer&&(clearTimeout(this._timer),this._timer=null);var e=t.proxy(function(){f.ping(f.SERVICE_TYPES.mobileOnExitHeartbeat,{cid:this.cfg.config.id,sid:this._measureName,rid:this.rid,uid:i.now()},function(){},function(){})},this);this._timer=setInterval(e,config.config.onExitMobileHeartbeatInterval),e()},i.registerProduct("foresee",config);var _=config.config.events,E=window!=window.top;if(_.loaded&&_.loaded(),r.loadedEmitter.fire(),("dontRunOtherIframes"!==config.config.workInIframes&&config.config.workInIframes||!E)&&!(window.__fsrtracker||window.location.toString().indexOf("survey.foreseeresults.com")>-1)){var S=window.location,T=function(){if(S=JSON.parse(JSON.stringify(window.location)),!(S.href.indexOf("fs.tracker.html")>-1)){var e=new i.Browser;e.ready.subscribe(function(){var s,n=i.getGlobalStore(e),o=new h(n,config),a=new i.CPPS(n),c=new i.Cookie({path:"/",secure:!1,encode:!0});n.ready.subscribe(t.proxy(function(){var f=r._journey=new i.Journey(config.config.id,config.config.site_id,n.uid,e);if(v(window,n,o,a,c,_,f),n.pers==i.storageTypes.MC||n.pers==i.storageTypes.CK){var u=n.get("didLogFP");u||(f.addEventObj({name:"fs_fingerprint",properties:{fp:[e.fp],uid:[n.uid]}}),n.set("didLogFP","1"))}var h=n.get("i");setTimeout(t.proxy(function(){if(a.set("url",window.location.toString()),config.config.cpps){var u,v=config.config.cpps;for(var m in v){var b=v[m];if(t.isObject(b))switch(b.source){case"param":var S=t.getParam(b.val)||b.init||null;if(t.isDefined(b.mode)&&"append"==b.mode){var T=b.delimiter||",",k=a.get(m),I=k?k.split(T):[];S=S||"",I[I.length-1]!==S&&(I.push(S),I.join(T),a.set(m,I))}else t.isDefined(S)&&null!==S?a.set(m,S):a.get(m)||a.set(m,"");break;case"variable":if(t.isDefined(b.name)){for(var D=window,C=b.name.split("."),R=0;R<C.length&&D;)D=D[C[R++]];R==C.length&&t.isDefined(D)?a.set(m,D):a.get(m)||a.set(m,b.init||"")}break;case"cookie":var x=c.get(b.val);t.isDefined(x)&&null!==x?a.set(m,x):a.get(m)||a.set(m,b.init||"");break;case"url":for(var A=0,O=b.patterns.length;A<O;A++)u=b.patterns[A].value,t.isString(location.href)&&location.href.match(b.patterns[A].regex)?a.set(m,u):a.get(m)||a.set(m,b.init||"");break;case"function":if(t.isFunction(b.value))try{u=b.value.call(window),a.set(m,u)}catch(e){}}else a.set(m,b)}}var N;if(n.get("ovr")&&(N=JSON.parse(n.get("ovr"))),N){for(var M=0;M<config.surveydefs.length;M++){var L=config.surveydefs[M].name;N.sp[L]&&(config.surveydefs[M].criteria.sp=N.sp[L]),N.lf[L]&&(config.surveydefs[M].criteria.lf=N.lf[L])}N.pooloverride===!0&&(o.pooloverride=!0)}if("a"==h){var P=parseInt(n.get("rw"));P<i.now()&&(n.erase("i"),n.erase("rw"),h=null)}if("runRecordOnly"===config.config.workInIframes&&E){for(var V=!1,U=0;U<config.surveydefs.length;U++){var H=config.surveydefs[U].cxRecord;if(H){V=!0;break}}return void y(e,V,n,!0,a)}if("d"!=h&&"a"!=h)o.calcReplayPoolStatus(function(u){o.optoutCheck(t.proxy(function(){if(o._match(config.config,e,"globalExclude")&&"y"!=n.get("gx")){var t=r.trig=w(n,config,e,o,a,c,_,f);if(t.logState(),a.set("pv",t.pageViewCount),t.init()&&(_.initialized&&_.initialized(a),r.initializedEmitter.fire(),t.doesPassCriteria()&&t.surveydef)){if(t.logDefState(),y(e,t.surveydef.cxRecord,n,u,a),"x"!=h){if(t.evalLoyaltySampling()&&t.canDisplayInvitation()){n.set("def",t.inviteIndex);new d(t,e,n,a,_,!1,f,function(){this.initialize()})}}else{var v=t.stg.get("mhbi");v?l(t,v.ui,v.it):t.tracker=new p(null,t.surveydef,config,n,_,a,null,e),t.surveydef&&n.set("defupdate",{name:t.surveydef.name},2e4,!0,i.persistDataType.TRACKER)}t.surveydef.links&&(s=new g(t.surveydef.links),s.performBindings(t))}}else n.set("gx","y")},this),function(){})});else if("a"==h){var K="true"==n.get("rc")||n.get("rc")===!0;y(e,K,n,K,a)}},this),Math.max(0,config.config.triggerDelay-(i.now()-t.startTS)))},this),!0,!0)},!0,!0)}};t.domReady(T);var k;i.pageNavEvent.subscribe(function(){var e=window,t=e.location,i=e[config.config.publicApiName||"FSR"],r=function(e){var t=e.split("#");return t.length>2?t[0]+t[1]:e.replace(/#/gi,"")},s=r(S.hash),n=r(t.hash);(i&&s!=n||S.pathname!=t.pathname)&&fsReady(function(){clearTimeout(k),k=setTimeout(function(){i.pageReset()},1500)})},!1,!1)}});